<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة التحكم | ثمرة المذاق</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #ff6b6b; --secondary: #00b894; --dark: #2d3436; --light: #f9f9f9; --blue: #0984e3; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); margin: 0; padding: 20px; }
        .admin-header { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .category-bar { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; border-bottom: 2px solid #eee; }
        .cat-btn { padding: 10px 20px; border: 2px solid var(--primary); border-radius: 25px; cursor: pointer; background: white; font-weight: bold; white-space: nowrap; }
        .cat-btn.active { background: var(--primary); color: white; }
        .action-btns { margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; }
        .btn-add { background: var(--secondary); }
        .btn-upload { background: var(--blue); }
        .btn-download { background: var(--dark); width: 100%; justify-content: center; font-size: 18px; margin-top: 20px; }
        .btn-edit { background: #f39c12; padding: 5px 15px; font-size: 14px; }
        .btn-delete { background: #d63031; padding: 5px 15px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 500px; max-height: 80vh; overflow-y: auto; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .variant-row { display: flex; gap: 10px; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px; align-items: center; }
    </style>
</head>
<body>

<div class="admin-header">
    <h2>إدارة الأقسام</h2>
    <div class="category-bar" id="categoryBar"></div>
    <div class="action-btns">
        <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importJSON(event)">
        <button class="btn btn-upload" onclick="document.getElementById('fileInput').click()">
            <i class="fa fa-upload"></i> رفع ملف data.json الحالي
        </button>
        
        <button class="btn btn-add" onclick="addNewCategory()">
            <i class="fa fa-plus"></i> إضافة قسم جديد
        </button>
        <button class="btn btn-edit" id="editCatBtn" onclick="editCurrentCategory()">تعديل اسم القسم</button>
        <button class="btn btn-delete" id="delCatBtn" onclick="deleteCategory()">حذف القسم</button>
    </div>
</div>

<div class="admin-header">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>الأصناف في قسم (<span id="selectedCatName">---</span>)</h2>
        <button class="btn btn-add" onclick="showItemModal()">+ إضافة صنف جديد</button>
    </div>
    <div id="itemsDisplay" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; margin-top:20px;"></div>
</div>

<button class="btn btn-download" onclick="downloadDataJSON()">
    <i class="fa fa-save"></i> حفظ وتحميل ملف data.json النهائي
</button>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">إضافة صنف جديد</h3>
        <label>القسم المستهدف:</label>
        <select id="itemCategorySelect"></select>
        
        <input type="text" id="itemName" placeholder="اسم الصنف (مثلاً: رمان)">
        
        <div id="variantsList">
            <label>الأحجام والأسعار:</label>
        </div>
        <button type="button" class="btn" style="background:#636e72; padding:5px 10px; font-size: 12px;" onclick="addVariantRow()">+ إضافة حجم/سعر</button>
        
        <div class="action-btns" style="justify-content: flex-end;">
            <button class="btn btn-add" id="saveItemBtn" onclick="saveItem()">حفظ الصنف</button>
            <button class="btn" style="background:#b2bec3;" onclick="closeModal()">إلغاء</button>
        </div>
    </div>
</div>

<script>
    let appData = { categories: [] };
    let currentCatIdx = 0;
    let editingItemIdx = null;

    // دالة رفع الملف وقراءته
    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                if (json.categories) {
                    appData = json;
                    currentCatIdx = 0;
                    renderAll();
                    alert("تم رفع الملف بنجاح! يمكنك الآن التعديل عليه.");
                } else {
                    alert("الملف المرفوع غير مدعوم، تأكد من بنية data.json");
                }
            } catch (err) {
                alert("خطأ في قراءة ملف JSON!");
            }
        };
        reader.readAsText(file);
    }

    function addNewCategory() {
        const name = prompt("أدخل اسم القسم الجديد:");
        if (name) {
            appData.categories.push({ name: name, items: [] });
            currentCatIdx = appData.categories.length - 1;
            renderAll();
        }
    }

    function editCurrentCategory() {
        if (!appData.categories[currentCatIdx]) return;
        const newName = prompt("تعديل اسم القسم:", appData.categories[currentCatIdx].name);
        if (newName) {
            appData.categories[currentCatIdx].name = newName;
            renderAll();
        }
    }

    function renderAll() {
        const bar = document.getElementById('categoryBar');
        const select = document.getElementById('itemCategorySelect');
        bar.innerHTML = '';
        select.innerHTML = '';

        appData.categories.forEach((cat, idx) => {
            const btn = document.createElement('button');
            btn.className = `cat-btn ${idx === currentCatIdx ? 'active' : ''}`;
            btn.innerText = cat.name;
            btn.onclick = () => { currentCatIdx = idx; renderAll(); };
            bar.appendChild(btn);
            select.innerHTML += `<option value="${idx}">${cat.name}</option>`;
        });

        if(appData.categories[currentCatIdx]) {
            document.getElementById('selectedCatName').innerText = appData.categories[currentCatIdx].name;
            renderItems();
        } else {
            document.getElementById('selectedCatName').innerText = "---";
            document.getElementById('itemsDisplay').innerHTML = "";
        }
    }

    function renderItems() {
        const display = document.getElementById('itemsDisplay');
        display.innerHTML = '';
        const items = appData.categories[currentCatIdx].items;

        items.forEach((item, idx) => {
            display.innerHTML += `
                <div style="background:white; padding:15px; border-radius:10px; text-align:center; border:1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                    <img src="images/${item.image}" style="width:80px; height:80px; border-radius:10px; object-fit:cover;" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
                    <h4 style="margin:10px 0;">${item.name}</h4>
                    <p style="font-size:12px; color:#666;">${item.variants.length} أحجام</p>
                    <div style="display:flex; gap:5px; justify-content:center; margin-top:10px;">
                        <button class="btn btn-edit" style="padding:5px 10px;" onclick="editItem(${idx})">تعديل</button>
                        <button class="btn btn-delete" style="padding:5px 10px;" onclick="deleteItem(${idx})">حذف</button>
                    </div>
                </div>`;
        });
    }

    function showItemModal() {
        if (appData.categories.length === 0) return alert("أضف قسماً أولاً!");
        editingItemIdx = null;
        document.getElementById('modalTitle').innerText = "إضافة صنف جديد";
        document.getElementById('itemName').value = "";
        document.getElementById('variantsList').innerHTML = "";
        addVariantRow();
        document.getElementById('itemModal').style.display = 'flex';
    }

    function editItem(idx) {
        editingItemIdx = idx;
        const item = appData.categories[currentCatIdx].items[idx];
        document.getElementById('modalTitle').innerText = "تعديل صنف: " + item.name;
        document.getElementById('itemName').value = item.name;
        document.getElementById('itemCategorySelect').value = currentCatIdx;
        
        document.getElementById('variantsList').innerHTML = "";
        item.variants.forEach(v => addVariantRow(v.size, v.price));
        
        document.getElementById('itemModal').style.display = 'flex';
    }

    function saveItem() {
        const name = document.getElementById('itemName').value;
        const targetCatIdx = document.getElementById('itemCategorySelect').value;
        const variants = [];
        
        document.querySelectorAll('.variant-row').forEach(row => {
            const s = row.querySelectorAll('input')[0].value;
            const p = row.querySelectorAll('input')[1].value;
            if(s && p) variants.push({ size: s, price: parseFloat(p) });
        });

        if(!name || variants.length === 0) return alert("أكمل البيانات!");

        const itemObj = { name, image: `${name}.jpg`, variants };

        if (editingItemIdx !== null) {
            appData.categories[currentCatIdx].items.splice(editingItemIdx, 1);
        }
        
        appData.categories[targetCatIdx].items.push(itemObj);
        
        closeModal();
        renderAll();
    }

    function addVariantRow(s = "", p = "") {
        const div = document.createElement('div');
        div.className = 'variant-row';
        div.innerHTML = `<input type="text" placeholder="الحجم" value="${s}"> 
                         <input type="number" placeholder="السعر" value="${p}">
                         <button onclick="this.parentElement.remove()" style="border:none; background:none; cursor:pointer;">❌</button>`;
        document.getElementById('variantsList').appendChild(div);
    }

    function closeModal() { document.getElementById('itemModal').style.display = 'none'; }

    function downloadDataJSON() {
        if (appData.categories.length === 0) return alert("لا توجد بيانات لحفظها!");
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = "data.json";
        link.click();
    }

    function deleteCategory() { 
        if(confirm("هل تريد حذف القسم وكل أصنافه نهائياً؟")) { 
            appData.categories.splice(currentCatIdx, 1); 
            currentCatIdx = 0;
            renderAll(); 
        } 
    }

    function deleteItem(idx) { 
        if(confirm("حذف هذا الصنف؟")) {
            appData.categories[currentCatIdx].items.splice(idx, 1); 
            renderItems(); 
        }
    }
</script>
</body>
</html>
