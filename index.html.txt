<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ثمرة المذاق المنعش - نظام الطلب الذاتي</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="cart-icon" onclick="toggleCartCard()">
    <div class="cart-badge" id="cart-count">0</div>
    <img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" alt="Cart">
</div>

<div id="custom-translate">
    <div id="lang-menu-btn">
        <img src="https://flagcdn.com/w40/sa.png" alt="Arabic">
        <span>اللغة / Language</span>
    </div>
    
    <div id="lang-options-card">
        <a href="javascript:void(0)" onclick="translatePage('ar')"><img src="https://flagcdn.com/w20/sa.png"> العربية</a>
        <a href="javascript:void(0)" onclick="translatePage('en')"><img src="https://flagcdn.com/w20/us.png"> English (US)</a>
        <a href="javascript:void(0)" onclick="translatePage('zh-CN')"><img src="https://flagcdn.com/w20/cn.png"> 中文 (الصينية)</a>
        <a href="javascript:void(0)" onclick="translatePage('hi')"><img src="https://flagcdn.com/w20/in.png"> हिन्दी (الهندية)</a>
        <a href="javascript:void(0)" onclick="translatePage('id')"><img src="https://flagcdn.com/w20/id.png"> Indonesia (الأندونيسية)</a>
        <a href="javascript:void(0)" onclick="translatePage('ru')"><img src="https://flagcdn.com/w20/ru.png"> Русский (الروسية)</a>
        <a href="javascript:void(0)" onclick="translatePage('tl')"><img src="https://flagcdn.com/w20/ph.png"> Tagalog (الفلبينية)</a>
        <a href="javascript:void(0)" onclick="translatePage('en')"><img src="https://flagcdn.com/w20/ng.png"> English (النيجيرية)</a>
        <a href="javascript:void(0)" onclick="translatePage('fr')"><img src="https://flagcdn.com/w20/fr.png"> Français (الفرنسية)</a>
        <a href="javascript:void(0)" onclick="translatePage('tr')"><img src="https://flagcdn.com/w20/tr.png"> Türkçe (التركية)</a>
        <a href="javascript:void(0)" onclick="translatePage('ms')"><img src="https://flagcdn.com/w20/my.png"> Melayu (الماليزية)</a>
        <a href="javascript:void(0)" onclick="translatePage('en')"><img src="https://flagcdn.com/w20/sg.png"> English (السنغافورية)</a>
        <a href="javascript:void(0)" onclick="translatePage('mn')"><img src="https://flagcdn.com/w20/mn.png"> Монгол (المنغولية)</a>
        <a href="javascript:void(0)" onclick="translatePage('fa')"><img src="https://flagcdn.com/w20/ir.png"> فارسی (الإيرانية)</a>
        <a href="javascript:void(0)" onclick="translatePage('ja')"><img src="https://flagcdn.com/w20/jp.png"> 日本語 (اليابانية)</a>
    </div>
</div>

<div id="google_translate_element" style="display:none;"></div>

<div class="container">
    <header class="hero-section">
        <div class="overlay"></div>
    </header>

    <div class="restaurant-info">
        <img src="images/logo.jpg" id="mainLogo" class="logo" onerror="checkOtherFormats(this)">
        <h1>ثمرة المذاق المنعش</h1>
    </div>

    <nav class="categories" id="main-nav"></nav>

    <div id="menu-container"></div>
</div>

<div id="itemModal" class="modal">
    <div class="modal-content">
        <span onclick="closeModal()" class="close-btn">&times;</span>
        <img id="modalImg" src="">
        <div class="modal-body">
            <h2 id="modalTitle"></h2>
            <div id="modalSizes"></div>
        </div>
    </div>
</div>

<div id="cartCard" class="cart-card">
    <div class="cart-card-header">
        <h3>سلة الطلبات</h3>
        <span onclick="toggleCartCard()" style="cursor:pointer; font-size: 24px;">&times;</span>
    </div>
    <div id="cart-items-container"></div>
    <div class="cart-footer">
        <div class="total-price">الإجمالي: <span id="cart-total-price">0</span> ريال</div>
        <button class="checkout-btn" onclick="printOrder()">دفع وطباعة الفاتورة</button>
    </div>
</div>

<script type="text/javascript">
    let cart = [];
    let orderNumber = localStorage.getItem('orderNumber') ? parseInt(localStorage.getItem('orderNumber')) : 1;

    function checkOtherFormats(img) {
        const paths = ['images/logo.png', 'images/Logo.jpg', 'images/لوجو.jpg', 'images/لوقو.jpg', 'images/الشعار.png'];
        let currentTry = parseInt(img.getAttribute('data-try') || 0);
        if (currentTry < paths.length) {
            img.setAttribute('data-try', currentTry + 1);
            img.src = paths[currentTry] + "?v=" + Math.random();
        }
    }

    // وظيفة جلب البيانات من ملف JSON
    async function initMenu() {
        try {
            const response = await fetch('data.json');
            const data = await response.json();
            renderApp(data.categories);
        } catch (error) {
            console.error("خطأ في تحميل البيانات:", error);
            document.getElementById('menu-container').innerHTML = "<h2 style='text-align:center;'>يرجى رفع ملف data.json أولاً</h2>";
        }
    }

    function renderApp(categories) {
        const nav = document.getElementById('main-nav');
        const container = document.getElementById('menu-container');
        nav.innerHTML = '';
        container.innerHTML = '';

        categories.forEach((cat, idx) => {
            // 1. بناء شريط التنقل العلوي
            const safeId = `section-${idx}`;
            nav.innerHTML += `<a href="#${safeId}" class="cat-item"><span>${cat.name}</span></a>`;

            // 2. بناء الأقسام والأصناف
            let sectionHtml = `
                <div id="${safeId}" class="menu-section">
                    <h2 class="section-title">${cat.name}</h2>
                    <div class="product-grid">`;
            
            cat.items.forEach(item => {
                const firstPrice = item.variants[0] ? item.variants[0].price : 0;
                sectionHtml += `
                    <div class="product-card" onclick='openItem(${JSON.stringify(item)}, "${cat.name}")'>
                        <div class="product-img">
                            <img src="images/${item.image}" onerror="this.src='https://placehold.jp/150x150.png'">
                        </div>
                        <div class="product-details">
                            <h3>${item.name}</h3>
                            <span class="price">من ${firstPrice} ريال</span>
                        </div>
                    </div>`;
            });

            sectionHtml += `</div></div>`;
            container.innerHTML += sectionHtml;
        });
    }

    function openItem(item, type) {
        let html = "";
        item.variants.forEach(v => {
            html += buildQtyControl(item.name, v.size, v.price, type);
        });
        showModal(item.name, `images/${item.image}`, html);
    }

    function buildQtyControl(name, size, price, type) {
        let currentQty = getQty(name, size);
        return `
        <div class="size-item-control">
            <span>${size} - ${price} ريال</span>
            <div class="qty-controls">
                <button onclick="changeQty('${name}', '${size}', ${price}, -1, '${type}')">-</button>
                <span id="qty-${name.replace(/\s/g, '')}-${size}">${currentQty}</span>
                <button onclick="changeQty('${name}', '${size}', ${price}, 1, '${type}')">+</button>
            </div>
        </div>`;
    }

    function getQty(name, size) {
        let item = cart.find(i => i.name === name && i.size === size);
        return item ? item.quantity : 0;
    }

    function changeQty(name, size, price, delta, type) {
        let index = cart.findIndex(i => i.name === name && i.size === size);
        if (index > -1) {
            cart[index].quantity += delta;
            if (cart[index].quantity <= 0) cart.splice(index, 1);
        } else if (delta > 0) {
            cart.push({ name, size, price, quantity: 1, type });
        }
        updateUI();
        let qtySpan = document.getElementById(`qty-${name.replace(/\s/g, '')}-${size}`);
        if(qtySpan) qtySpan.innerText = getQty(name, size);
    }

    function updateUI() {
        let count = cart.reduce((a, b) => a + b.quantity, 0);
        let total = cart.reduce((a, b) => a + (b.price * b.quantity), 0);
        document.getElementById('cart-count').innerText = count;
        document.getElementById('cart-total-price').innerText = total;
        
        const messages = {
            'ar': "توجه إلى الكاشير للدفع", 'en': "Please proceed to the cashier for payment",
            'zh-CN': "请到收银台付款", 'hi': "कृपया भुगतान के लिए कैशियर के पास जाएं",
            'id': "Silakan pergi ke kasir untuk pembayaran", 'ru': "Пожалуйста, пройдите к кассиру для оплаты",
            'tl': "Mangyaring pumunta sa cashier para magbayad", 'fr': "Veuillez vous rendre à la caisse pour le paiement",
            'tr': "Lütfen ödeme için kasaya gidiniz", 'ms': "Sila pergi ke juruwang untuk pembayaran",
            'fa': "لطفاً برای پرداخت به صندوق مراجعه کنید", 'ja': "レジまでお越しください",
            'mn': "Төлбөрөө кассанд очиж тушаана уу", 'vi': "Vui lòng đến quầy thu ngân để thanh toán",
            'ur': "براہ کرم ادائیگی کے لیے کیشئر کے پاس جائیں"
        };

        let currentLang = 'ar'; 
        const combo = document.querySelector('select.goog-te-combo');
        if (combo && combo.value) currentLang = combo.value;

        let directionMsg = messages[currentLang] || messages['en'];
        let container = document.getElementById('cart-items-container');
        container.innerHTML = `<div class="direction-notice">${directionMsg}</div>`;
        
        cart.forEach(item => {
            container.innerHTML += `
                <div class="cart-item-row">
                    <div><b>${item.name}</b> (${item.size})</div>
                    <div class="qty-controls">
                        <button onclick="changeQty('${item.name}', '${item.size}', ${item.price}, -1, '${item.type}')">-</button>
                        <span>${item.quantity}</span>
                        <button onclick="changeQty('${item.name}', '${item.size}', ${item.price}, 1, '${item.type}')">+</button>
                    </div>
                </div>`;
        });
    }

    function toggleCartCard() {
        let card = document.getElementById('cartCard');
        card.style.display = card.style.display === "flex" ? "none" : "flex";
    }

    function showModal(name, img, content) {
        document.getElementById('modalTitle').innerText = name;
        document.getElementById('modalImg').src = img;
        document.getElementById('modalSizes').innerHTML = content;
        document.getElementById('itemModal').style.display = "flex";
    }

    function closeModal() { document.getElementById('itemModal').style.display = "none"; }
    window.onclick = function(event) { if (event.target == document.getElementById('itemModal')) closeModal(); }

    function printOrder() {
        if (cart.length === 0) return alert("السلة فارغة!");
        const lang = document.documentElement.lang;
        const msg = lang === 'ar' ? "توجه إلى الكاشير للدفع" : "Please proceed to the cashier for payment";
        let total = document.getElementById('cart-total-price').innerText;

        let printWindow = window.open('', '_blank');
        let html = `<html><head><style>
            body { font-family: sans-serif; text-align: center; width: 80mm; margin: 0 auto; padding: 10px; }
            .receipt-header { border-bottom: 2px dashed #000; padding: 10px 0; margin-bottom: 10px; }
            .item-line { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; text-align: right; }
            .total { border-top: 2px solid #000; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 18px; }
            .order-id { font-size: 24px; font-weight: 900; margin: 10px 0; }
            .section-slip { page-break-before: always; border-top: 2px dashed #000; padding-top: 20px; margin-top: 20px; }
        </style></head><body>
            <div class="receipt-header">
                <h2 style="margin:0;">ثمرة المذاق المنعش</h2>
                <div class="order-id">رقم الطلب: #${orderNumber}</div>
                <p style="font-weight:bold;">${msg}</p>
                <p style="font-size:12px;">التاريخ: ${new Date().toLocaleString()}</p>
            </div>`;

        cart.forEach(item => {
            html += `<div class="item-line"><span>${item.name} (${item.size}) x${item.quantity}</span><span>${item.price * item.quantity} ريال</span></div>`;
        });
        html += `<div class="total">الإجمالي: ${total} ريال</div>`;

        const types = [...new Set(cart.map(i => i.type))];
        types.forEach(t => {
            html += `<div class="section-slip"><h3>قسم: ${t.toUpperCase()}</h3><div class="order-id">رقم الطلب: #${orderNumber}</div>`;
            cart.filter(i => i.type === t).forEach(item => {
                html += `<div class="item-line" style="font-size:16px;"><span>● ${item.name} (${item.size}) x${item.quantity}</span></div>`;
            });
            html += `</div>`;
        });

        html += `</body></html>`;
        printWindow.document.write(html);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(() => { 
            printWindow.print(); 
            printWindow.close(); 
            orderNumber++;
            localStorage.setItem('orderNumber', orderNumber);
            cart = []; 
            updateUI(); 
            if(document.getElementById('cartCard').style.display === "flex") toggleCartCard();
        }, 500);
    }

    function translatePage(langCode) {
        var select = document.querySelector('select.goog-te-combo');
        if (select) { 
            select.value = langCode; 
            select.dispatchEvent(new Event('change'));
            if (langCode === 'ar') { setTimeout(function() { location.reload(); }, 300); }
        }
    }

    function googleTranslateElementInit() {
        new google.translate.TranslateElement({pageLanguage: 'ar', autoDisplay: false}, 'google_translate_element');
    }

    setInterval(function() {
        var googleFrame = document.querySelector(".skiptranslate");
        if (googleFrame) { googleFrame.style.display = "none"; }
        document.body.style.top = "0px";
    }, 500);

    // بدء التشغيل
    initMenu();
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
</body>
</html>